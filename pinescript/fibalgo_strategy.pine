//@version=6
strategy("FibAlgo Strategy", overlay=true, default_qty_type=strategy.fixed, default_qty_value=1, initial_capital=100000, commission_type=strategy.commission.percent, commission_value=0.1, slippage=1, max_lines_count=500, max_labels_count=500, max_boxes_count=50)

// ═══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ═══════════════════════════════════════════════════════════════════════════════

pivotLen       = input.int(5, "Pivot Length", minval=2, maxval=20, group="Swing Detection")

riskPercent    = input.float(1.0, "Risk %", minval=0.1, maxval=5.0, step=0.1, group="Risk Management")
accountSize    = input.float(100000, "Account Size ($)", minval=100, group="Risk Management")
maxLossDollars = input.float(100, "Max Loss Per Trade ($)", minval=10, step=10, group="Risk Management")
atrLen         = input.int(14, "ATR Length", minval=1, group="Risk Management")
atrMult        = input.float(0.5, "ATR SL Buffer", minval=0.1, maxval=2.0, step=0.1, group="Risk Management")
minRR          = input.float(1.5, "Min R:R", minval=0.5, maxval=5.0, step=0.1, group="Risk Management")

partialExitPct = input.int(50, "TP1 Exit %", minval=10, maxval=90, step=5, group="Exit Strategy")

trendEmaLen    = input.int(21, "EMA Channel Length", minval=5, group="Trend")
emaSlowLen     = input.int(50, "Slow EMA", minval=10, group="Trend")
channelMult    = input.float(1.5, "Channel ATR Mult", minval=0.5, maxval=3.0, step=0.1, group="Trend")

showFibs       = input.bool(true, "Show Fib Lines", group="Display")
showDashboard  = input.bool(true, "Show Dashboard", group="Display")
showChannel    = input.bool(true, "Show EMA Channel", group="Display")
showSignals    = input.bool(true, "Show BUY/SELL Labels", group="Display")

// ═══════════════════════════════════════════════════════════════════════════════
// CORE CALCULATIONS
// ═══════════════════════════════════════════════════════════════════════════════

atrVal    = ta.atr(atrLen)
emaFast   = ta.ema(close, trendEmaLen)
emaSlow   = ta.ema(close, emaSlowLen)
atrCh     = ta.atr(atrLen)
chUpper   = emaFast + atrCh * channelMult
chLower   = emaFast - atrCh * channelMult

// ═══════════════════════════════════════════════════════════════════════════════
// SWING DETECTION
// ═══════════════════════════════════════════════════════════════════════════════

pivotHigh = ta.pivothigh(high, pivotLen, pivotLen)
pivotLow  = ta.pivotlow(low, pivotLen, pivotLen)

var float swHigh    = na
var int   swHighBar = na
var float swLow     = na
var int   swLowBar  = na
var bool  newSwing  = false

newSwing := false

if not na(pivotHigh)
    swHigh    := pivotHigh
    swHighBar := bar_index - pivotLen
    newSwing  := true

if not na(pivotLow)
    swLow    := pivotLow
    swLowBar := bar_index - pivotLen
    newSwing := true

// ═══════════════════════════════════════════════════════════════════════════════
// TREND DIRECTION
// ═══════════════════════════════════════════════════════════════════════════════

bool isBull = close > emaFast and emaFast > emaSlow
bool isBear = close < emaFast and emaFast < emaSlow

// ═══════════════════════════════════════════════════════════════════════════════
// FIBONACCI LEVELS — always calculated when both swing points exist
// ═══════════════════════════════════════════════════════════════════════════════

bool hasSwings = not na(swHigh) and not na(swLow) and swHigh > swLow
float swRange  = hasSwings ? swHigh - swLow : na

float fib236 = na
float fib382 = na
float fib500 = na
float fib618 = na
float fib786 = na
float ext127 = na
float ext162 = na

if hasSwings
    fib236 := swHigh - swRange * 0.236
    fib382 := swHigh - swRange * 0.382
    fib500 := swHigh - swRange * 0.500
    fib618 := swHigh - swRange * 0.618
    fib786 := swHigh - swRange * 0.786
    ext127 := swLow + swRange * 1.272
    ext162 := swLow + swRange * 1.618

// ATR percentage
float atrPct = not na(atrVal) and close > 0 ? (atrVal / close) * 100 : na

// ═══════════════════════════════════════════════════════════════════════════════
// ENTRY LOGIC
// ═══════════════════════════════════════════════════════════════════════════════

// Long: price pulls back to 38.2%-61.8% zone + bullish candle + bullish trend
bool longGZ = hasSwings and isBull and low <= fib382 and close >= fib618 and close > open and strategy.position_size == 0

// Short: price rallies to 38.2%-61.8% zone + bearish candle + bearish trend
bool shortGZ = hasSwings and isBear and high >= fib618 and close <= fib382 and close < open and strategy.position_size == 0

// ═══════════════════════════════════════════════════════════════════════════════
// POSITION SIZING & SL/TP
// ═══════════════════════════════════════════════════════════════════════════════

// SL levels (always calculated for dashboard)
float longSLprice  = hasSwings ? swLow - nz(atrVal) * atrMult : na
float shortSLprice = hasSwings ? swHigh + nz(atrVal) * atrMult : na

// Long sizing
float longTP1 = na
float longTP2 = na
float longQty = na
float longRR  = na

if longGZ and not na(longSLprice)
    float sd = close - longSLprice
    if sd > 0 and not na(ext127)
        longTP1 := ext127
        longTP2 := ext162
        longRR  := (longTP1 - close) / sd
        longQty := math.max(1, math.floor(maxLossDollars / sd))

// Short sizing
float shortTP1 = na
float shortTP2 = na
float shortQty = na
float shortRR  = na

if shortGZ and not na(shortSLprice)
    float sd = shortSLprice - close
    if sd > 0 and not na(ext127)
        shortTP1 := swLow - (swRange * 0.272)
        shortTP2 := swLow - (swRange * 0.618)
        shortRR  := (close - shortTP1) / sd
        shortQty := math.max(1, math.floor(maxLossDollars / sd))

// ═══════════════════════════════════════════════════════════════════════════════
// STRATEGY ENTRIES & EXITS
// ═══════════════════════════════════════════════════════════════════════════════

bool goLong  = longGZ and not na(longRR) and longRR >= minRR
bool goShort = shortGZ and not na(shortRR) and shortRR >= minRR

if goLong
    strategy.entry("Long", strategy.long, qty=longQty)
    strategy.exit("LTP1", "Long", qty_percent=partialExitPct, limit=longTP1, stop=longSLprice)
    strategy.exit("LTP2", "Long", qty_percent=100, limit=longTP2, stop=longSLprice)

if goShort
    strategy.entry("Short", strategy.short, qty=shortQty)
    strategy.exit("STP1", "Short", qty_percent=partialExitPct, limit=shortTP1, stop=shortSLprice)
    strategy.exit("STP2", "Short", qty_percent=100, limit=shortTP2, stop=shortSLprice)

// ═══════════════════════════════════════════════════════════════════════════════
// VISUALS — EMA CHANNEL (teal bands like FTI)
// ═══════════════════════════════════════════════════════════════════════════════

p1 = plot(showChannel ? chUpper : na, "Channel Upper", color=color.new(color.teal, 40), linewidth=1)
p2 = plot(showChannel ? chLower : na, "Channel Lower", color=color.new(color.teal, 40), linewidth=1)
pm = plot(showChannel ? emaFast : na, "EMA Mid", color=color.new(color.teal, 60), linewidth=1)
fill(p1, p2, color=color.new(color.teal, 90))

// ═══════════════════════════════════════════════════════════════════════════════
// VISUALS — FIBONACCI LINES (RED for resistance, BLUE for support)
// ═══════════════════════════════════════════════════════════════════════════════

var line ln236 = na, var label lb236 = na
var line ln382 = na, var label lb382 = na
var line ln500 = na, var label lb500 = na
var line ln618 = na, var label lb618 = na
var line ln786 = na, var label lb786 = na
var line lnE127 = na, var label lbE127 = na
var line lnE162 = na, var label lbE162 = na
var line lnHigh = na, var label lbHigh = na
var line lnLow  = na, var label lbLow  = na

drawFibLine(float price, string txt, color col, int w, bool dashed, int startB) =>
    sty = dashed ? line.style_dashed : line.style_solid
    l  = line.new(startB, price, bar_index + 20, price, color=col, width=w, style=sty, extend=extend.right)
    lb = label.new(bar_index + 3, price, txt + "  " + str.tostring(price, format.mintick), style=label.style_none, textcolor=col, size=size.small)
    [l, lb]

bool redraw = newSwing or (bar_index % 40 == 0)

if showFibs and redraw and hasSwings
    line.delete(ln236), label.delete(lb236)
    line.delete(ln382), label.delete(lb382)
    line.delete(ln500), label.delete(lb500)
    line.delete(ln618), label.delete(lb618)
    line.delete(ln786), label.delete(lb786)
    line.delete(lnE127), label.delete(lbE127)
    line.delete(lnE162), label.delete(lbE162)
    line.delete(lnHigh), label.delete(lbHigh)
    line.delete(lnLow), label.delete(lbLow)

    int sB = na(swHighBar) or na(swLowBar) ? bar_index - 40 : math.min(swHighBar, swLowBar)

    // Swing reference lines
    [lH, labH] = drawFibLine(swHigh, "High", color.new(color.white, 50), 1, false, sB)
    lnHigh := lH, lbHigh := labH
    [lL, labL] = drawFibLine(swLow, "Low", color.new(color.white, 50), 1, false, sB)
    lnLow := lL, lbLow := labL

    // Levels above current price = RED (resistance), below = BLUE (support)
    // 23.6%
    c236 = close < fib236 ? color.new(color.red, 30) : color.new(color.blue, 30)
    [l1, lb1] = drawFibLine(fib236, "23.6%", c236, 1, false, sB)
    ln236 := l1, lb236 := lb1

    // 38.2%
    c382 = close < fib382 ? color.new(color.red, 20) : color.new(color.blue, 20)
    [l2, lb2] = drawFibLine(fib382, "38.2%", c382, 2, false, sB)
    ln382 := l2, lb382 := lb2

    // 50%
    c500 = close < fib500 ? color.new(color.red, 30) : color.new(color.blue, 30)
    [l3, lb3] = drawFibLine(fib500, "50%", c500, 1, false, sB)
    ln500 := l3, lb500 := lb3

    // 61.8%
    c618 = close < fib618 ? color.new(color.red, 20) : color.new(color.blue, 20)
    [l4, lb4] = drawFibLine(fib618, "61.8%", c618, 2, false, sB)
    ln618 := l4, lb618 := lb4

    // 78.6%
    c786 = close < fib786 ? color.new(color.red, 30) : color.new(color.blue, 30)
    [l5, lb5] = drawFibLine(fib786, "78.6%", c786, 1, false, sB)
    ln786 := l5, lb786 := lb5

    // Extensions (always resistance = red, dashed)
    if not na(ext127)
        [le1, lbe1] = drawFibLine(ext127, "127.2%", color.new(color.red, 20), 1, true, sB)
        lnE127 := le1, lbE127 := lbe1
    if not na(ext162)
        [le2, lbe2] = drawFibLine(ext162, "161.8%", color.new(color.red, 20), 1, true, sB)
        lnE162 := le2, lbE162 := lbe2

// ═══════════════════════════════════════════════════════════════════════════════
// VISUALS — BUY / SELL LABELS (FTI style)
// ═══════════════════════════════════════════════════════════════════════════════

if showSignals and goLong
    label.new(bar_index, low, "BUY", style=label.style_label_up, color=color.new(color.blue, 10), textcolor=color.white, size=size.normal)

if showSignals and goShort
    label.new(bar_index, high, "SELL", style=label.style_label_down, color=color.new(color.orange, 10), textcolor=color.white, size=size.normal)

// Background when in trade
bgcolor(strategy.position_size > 0 ? color.new(color.green, 95) : strategy.position_size < 0 ? color.new(color.red, 95) : na)

// ═══════════════════════════════════════════════════════════════════════════════
// DASHBOARD — FTI style (bottom-left, blue background)
// ═══════════════════════════════════════════════════════════════════════════════

if showDashboard and barstate.islast
    var table dash = table.new(position.bottom_left, 2, 10, bgcolor=color.new(color.blue, 40), border_width=1, border_color=color.new(color.blue, 20), frame_width=2, frame_color=color.new(color.blue, 10))

    // Header
    table.cell(dash, 0, 0, "FibAlgo", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.blue, 20))
    table.cell(dash, 1, 0, "STRATEGY", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.blue, 20))

    // Direction
    string dir = strategy.position_size > 0 ? "LONG" : strategy.position_size < 0 ? "SHORT" : isBull ? "Long" : "Short"
    color dirCol = (strategy.position_size > 0 or isBull) ? color.green : color.red
    table.cell(dash, 0, 1, "Direction", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 1, dir, text_color=dirCol, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // Entry / Current Price
    table.cell(dash, 0, 2, "Price", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 2, str.tostring(close, format.mintick), text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // Qty (auto)
    float currentQty = strategy.position_size != 0 ? math.abs(strategy.position_size) : isBull and hasSwings and not na(longSLprice) and (close - longSLprice) > 0 ? math.max(1, math.floor(maxLossDollars / (close - longSLprice))) : isBear and hasSwings and not na(shortSLprice) and (shortSLprice - close) > 0 ? math.max(1, math.floor(maxLossDollars / (shortSLprice - close))) : na
    table.cell(dash, 0, 3, "Qty (auto)", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 3, not na(currentQty) ? str.tostring(currentQty, "#") : "—", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // Max Loss
    table.cell(dash, 0, 4, "Max Loss", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 4, "$ " + str.tostring(maxLossDollars, "#"), text_color=color.red, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // Long SL
    table.cell(dash, 0, 5, "SL Long", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 5, not na(longSLprice) ? str.tostring(longSLprice, format.mintick) : "—", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // Short SL
    table.cell(dash, 0, 6, "SL Short", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 6, not na(shortSLprice) ? str.tostring(shortSLprice, format.mintick) : "—", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // TP1 / TP2
    float dispTP1 = isBull and not na(ext127) ? ext127 : isBear and hasSwings ? swLow - swRange * 0.272 : na
    float dispTP2 = isBull and not na(ext162) ? ext162 : isBear and hasSwings ? swLow - swRange * 0.618 : na
    table.cell(dash, 0, 7, "TP1 / TP2", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    tp1Str = not na(dispTP1) ? str.tostring(dispTP1, format.mintick) : "—"
    tp2Str = not na(dispTP2) ? str.tostring(dispTP2, format.mintick) : "—"
    table.cell(dash, 1, 7, tp1Str + " / " + tp2Str, text_color=color.green, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // R:R
    float dispRR = na
    if isBull and hasSwings and not na(ext127) and not na(longSLprice) and (close - longSLprice) > 0
        dispRR := (ext127 - close) / (close - longSLprice)
    if isBear and hasSwings and not na(shortSLprice) and (shortSLprice - close) > 0
        float sTP1 = swLow - swRange * 0.272
        dispRR := (close - sTP1) / (shortSLprice - close)
    table.cell(dash, 0, 8, "R:R", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 8, not na(dispRR) and dispRR > 0 ? str.tostring(dispRR, "#.##") + " : 1" : "—", text_color=color.yellow, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // ATR %
    table.cell(dash, 0, 9, "ATR %", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 9, not na(atrPct) ? str.tostring(atrPct, "#.##") + "%" : "—", text_color=color.yellow, text_size=size.small, bgcolor=color.new(color.blue, 50))
