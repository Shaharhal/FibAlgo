//@version=6
indicator("FibAlgo", overlay=true, max_lines_count=500, max_labels_count=500, max_boxes_count=50, max_bars_back=5000)

// ═══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ═══════════════════════════════════════════════════════════════════════════════

pivotLen       = input.int(5, "Pivot Length", minval=2, maxval=20, group="Swing Detection")

accountSize    = input.float(100000, "Account Size ($)", minval=100, group="Risk Management")
maxLossDollars = input.float(100, "Max Loss Per Trade ($)", minval=10, step=10, group="Risk Management")
atrLen         = input.int(14, "ATR Length", minval=1, group="Risk Management")
atrMult        = input.float(0.5, "ATR SL Buffer", minval=0.1, maxval=2.0, step=0.1, group="Risk Management")
minRR          = input.float(1.5, "Min R:R", minval=0.5, maxval=5.0, step=0.1, group="Risk Management")
partialExitPct = input.float(50.0, "TP1 Exit %", minval=10, maxval=90, step=5, group="Risk Management")

trendEmaLen    = input.int(21, "EMA Channel Length", minval=5, group="Trend")
emaSlowLen     = input.int(50, "Slow EMA", minval=10, group="Trend")
channelMult    = input.float(1.5, "Channel ATR Mult", minval=0.5, maxval=3.0, step=0.1, group="Trend")

showFibs       = input.bool(true, "Show Fib Lines", group="Display")
showDashboard  = input.bool(true, "Show Dashboard", group="Display")
showChannel    = input.bool(true, "Show EMA Channel", group="Display")
showSignals    = input.bool(true, "Show BUY/SELL Labels", group="Display")
showSwings     = input.bool(true, "Show Swing Markers", group="Display")

// ═══════════════════════════════════════════════════════════════════════════════
// CORE CALCULATIONS
// ═══════════════════════════════════════════════════════════════════════════════

atrVal  = ta.atr(atrLen)
emaFast = ta.ema(close, trendEmaLen)
emaSlow = ta.ema(close, emaSlowLen)
chUpper = emaFast + atrVal * channelMult
chLower = emaFast - atrVal * channelMult

// ═══════════════════════════════════════════════════════════════════════════════
// SWING DETECTION
// ═══════════════════════════════════════════════════════════════════════════════

pivotHigh = ta.pivothigh(high, pivotLen, pivotLen)
pivotLow  = ta.pivotlow(low, pivotLen, pivotLen)

var float swHigh    = na
var int   swHighBar = na
var float swLow     = na
var int   swLowBar  = na
var bool  newSwing  = false

newSwing := false

if not na(pivotHigh)
    swHigh    := pivotHigh
    swHighBar := bar_index - pivotLen
    newSwing  := true

if not na(pivotLow)
    swLow    := pivotLow
    swLowBar := bar_index - pivotLen
    newSwing := true

// ═══════════════════════════════════════════════════════════════════════════════
// TREND
// ═══════════════════════════════════════════════════════════════════════════════

bool isBull = close > emaFast and emaFast > emaSlow
bool isBear = close < emaFast and emaFast < emaSlow

// ═══════════════════════════════════════════════════════════════════════════════
// FIBONACCI LEVELS
// ═══════════════════════════════════════════════════════════════════════════════

bool hasSwings = not na(swHigh) and not na(swLow) and swHigh > swLow
float swRange  = hasSwings ? swHigh - swLow : na

float fib236 = na
float fib382 = na
float fib500 = na
float fib618 = na
float fib786 = na
float ext127 = na
float ext162 = na

if hasSwings
    fib236 := swHigh - swRange * 0.236
    fib382 := swHigh - swRange * 0.382
    fib500 := swHigh - swRange * 0.500
    fib618 := swHigh - swRange * 0.618
    fib786 := swHigh - swRange * 0.786
    ext127 := swLow + swRange * 1.272
    ext162 := swLow + swRange * 1.618

float atrPct = not na(atrVal) and close > 0 ? (atrVal / close) * 100 : na

// ═══════════════════════════════════════════════════════════════════════════════
// SL / TP / SIZING (always calculated for dashboard)
// ═══════════════════════════════════════════════════════════════════════════════

float longSL  = hasSwings ? swLow - nz(atrVal) * atrMult : na
float shortSL = hasSwings ? swHigh + nz(atrVal) * atrMult : na

float longTP1  = ext127
float longTP2  = ext162
float shortTP1 = hasSwings ? swLow - swRange * 0.272 : na
float shortTP2 = hasSwings ? swLow - swRange * 0.618 : na

float longQty  = not na(longSL) and (close - longSL) > 0 ? math.max(1, math.floor(maxLossDollars / (close - longSL))) : na
float shortQty = not na(shortSL) and (shortSL - close) > 0 ? math.max(1, math.floor(maxLossDollars / (shortSL - close))) : na

float longRR  = not na(longTP1) and not na(longSL) and (close - longSL) > 0 ? (longTP1 - close) / (close - longSL) : na
float shortRR = not na(shortTP1) and not na(shortSL) and (shortSL - close) > 0 ? (close - shortTP1) / (shortSL - close) : na

// ═══════════════════════════════════════════════════════════════════════════════
// ENTRY SIGNALS
// ═══════════════════════════════════════════════════════════════════════════════

var bool longActive  = false
var bool shortActive = false

bool longEntry  = hasSwings and isBull and low <= fib382 and close >= fib618 and close > open and not longActive
bool shortEntry = hasSwings and isBear and high >= fib618 and close <= fib382 and close < open and not shortActive

// Filter by R:R
bool validLong  = longEntry and not na(longRR) and longRR >= minRR
bool validShort = shortEntry and not na(shortRR) and shortRR >= minRR

if validLong
    longActive  := true
    shortActive := false

if validShort
    shortActive := true
    longActive  := false

// Reset on new swing
if newSwing
    longActive  := false
    shortActive := false

// ═══════════════════════════════════════════════════════════════════════════════
// VISUALS — EMA CHANNEL
// ═══════════════════════════════════════════════════════════════════════════════

p1 = plot(showChannel ? chUpper : na, "Ch Upper", color=color.new(color.teal, 40), linewidth=1)
p2 = plot(showChannel ? chLower : na, "Ch Lower", color=color.new(color.teal, 40), linewidth=1)
plot(showChannel ? emaFast : na, "EMA Fast", color=color.new(color.teal, 60), linewidth=1)
fill(p1, p2, color=color.new(color.teal, 90))

// ═══════════════════════════════════════════════════════════════════════════════
// VISUALS — FIB LINES (RED = resistance, BLUE = support)
// ═══════════════════════════════════════════════════════════════════════════════

var line ln236 = na, var label lb236 = na
var line ln382 = na, var label lb382 = na
var line ln500 = na, var label lb500 = na
var line ln618 = na, var label lb618 = na
var line ln786 = na, var label lb786 = na
var line lnE127 = na, var label lbE127 = na
var line lnE162 = na, var label lbE162 = na
var line lnHigh = na, var label lbHigh = na
var line lnLow  = na, var label lbLow  = na

drawFibLine(float price, string txt, color col, int w, bool dashed, int startB) =>
    sty = dashed ? line.style_dashed : line.style_solid
    l  = line.new(startB, price, bar_index + 20, price, color=col, width=w, style=sty, extend=extend.right)
    lb = label.new(bar_index + 3, price, txt + "  " + str.tostring(price, format.mintick), style=label.style_none, textcolor=col, size=size.small)
    [l, lb]

bool redraw = newSwing or (bar_index % 40 == 0)

if showFibs and redraw and hasSwings
    line.delete(ln236), label.delete(lb236)
    line.delete(ln382), label.delete(lb382)
    line.delete(ln500), label.delete(lb500)
    line.delete(ln618), label.delete(lb618)
    line.delete(ln786), label.delete(lb786)
    line.delete(lnE127), label.delete(lbE127)
    line.delete(lnE162), label.delete(lbE162)
    line.delete(lnHigh), label.delete(lbHigh)
    line.delete(lnLow), label.delete(lbLow)

    int sB = na(swHighBar) or na(swLowBar) ? bar_index - 40 : math.min(swHighBar, swLowBar)

    [lH, labH] = drawFibLine(swHigh, "High", color.new(color.white, 50), 1, false, sB)
    lnHigh := lH, lbHigh := labH
    [lL, labL] = drawFibLine(swLow, "Low", color.new(color.white, 50), 1, false, sB)
    lnLow := lL, lbLow := labL

    c236 = close < fib236 ? color.new(color.red, 30) : color.new(color.blue, 30)
    [l1, lb1] = drawFibLine(fib236, "23.6%", c236, 1, false, sB)
    ln236 := l1, lb236 := lb1

    c382 = close < fib382 ? color.new(color.red, 20) : color.new(color.blue, 20)
    [l2, lb2] = drawFibLine(fib382, "38.2%", c382, 2, false, sB)
    ln382 := l2, lb382 := lb2

    c500 = close < fib500 ? color.new(color.red, 30) : color.new(color.blue, 30)
    [l3, lb3] = drawFibLine(fib500, "50%", c500, 1, false, sB)
    ln500 := l3, lb500 := lb3

    c618 = close < fib618 ? color.new(color.red, 20) : color.new(color.blue, 20)
    [l4, lb4] = drawFibLine(fib618, "61.8%", c618, 2, false, sB)
    ln618 := l4, lb618 := lb4

    c786 = close < fib786 ? color.new(color.red, 30) : color.new(color.blue, 30)
    [l5, lb5] = drawFibLine(fib786, "78.6%", c786, 1, false, sB)
    ln786 := l5, lb786 := lb5

    if not na(ext127)
        [le1, lbe1] = drawFibLine(ext127, "127.2%", color.new(color.red, 20), 1, true, sB)
        lnE127 := le1, lbE127 := lbe1
    if not na(ext162)
        [le2, lbe2] = drawFibLine(ext162, "161.8%", color.new(color.red, 20), 1, true, sB)
        lnE162 := le2, lbE162 := lbe2

// ═══════════════════════════════════════════════════════════════════════════════
// VISUALS — SWING MARKERS
// ═══════════════════════════════════════════════════════════════════════════════

if showSwings and not na(pivotHigh)
    label.new(bar_index - pivotLen, high[pivotLen], "▼", style=label.style_none, textcolor=color.red, size=size.small)

if showSwings and not na(pivotLow)
    label.new(bar_index - pivotLen, low[pivotLen], "▲", style=label.style_none, textcolor=color.green, size=size.small)

// ═══════════════════════════════════════════════════════════════════════════════
// VISUALS — BUY / SELL LABELS
// ═══════════════════════════════════════════════════════════════════════════════

if showSignals and validLong
    label.new(bar_index, low, "BUY", style=label.style_label_up, color=color.new(color.blue, 10), textcolor=color.white, size=size.normal)

if showSignals and validShort
    label.new(bar_index, high, "SELL", style=label.style_label_down, color=color.new(color.orange, 10), textcolor=color.white, size=size.normal)

// ═══════════════════════════════════════════════════════════════════════════════
// VISUALS — SL/TP LINES on entry
// ═══════════════════════════════════════════════════════════════════════════════

var line slLine  = na, var label slLab  = na
var line tp1Line = na, var label tp1Lab = na
var line tp2Line = na, var label tp2Lab = na

if validLong
    line.delete(slLine), label.delete(slLab)
    line.delete(tp1Line), label.delete(tp1Lab)
    line.delete(tp2Line), label.delete(tp2Lab)
    slLine  := line.new(bar_index, longSL, bar_index + 20, longSL, color=color.red, width=1, style=line.style_dotted, extend=extend.right)
    slLab   := label.new(bar_index + 3, longSL, "SL " + str.tostring(longSL, format.mintick), style=label.style_none, textcolor=color.red, size=size.tiny)
    tp1Line := line.new(bar_index, longTP1, bar_index + 20, longTP1, color=color.green, width=1, style=line.style_dotted, extend=extend.right)
    tp1Lab  := label.new(bar_index + 3, longTP1, "TP1 " + str.tostring(longTP1, format.mintick), style=label.style_none, textcolor=color.green, size=size.tiny)
    tp2Line := line.new(bar_index, longTP2, bar_index + 20, longTP2, color=color.lime, width=1, style=line.style_dotted, extend=extend.right)
    tp2Lab  := label.new(bar_index + 3, longTP2, "TP2 " + str.tostring(longTP2, format.mintick), style=label.style_none, textcolor=color.lime, size=size.tiny)

if validShort
    line.delete(slLine), label.delete(slLab)
    line.delete(tp1Line), label.delete(tp1Lab)
    line.delete(tp2Line), label.delete(tp2Lab)
    slLine  := line.new(bar_index, shortSL, bar_index + 20, shortSL, color=color.red, width=1, style=line.style_dotted, extend=extend.right)
    slLab   := label.new(bar_index + 3, shortSL, "SL " + str.tostring(shortSL, format.mintick), style=label.style_none, textcolor=color.red, size=size.tiny)
    tp1Line := line.new(bar_index, shortTP1, bar_index + 20, shortTP1, color=color.green, width=1, style=line.style_dotted, extend=extend.right)
    tp1Lab  := label.new(bar_index + 3, shortTP1, "TP1 " + str.tostring(shortTP1, format.mintick), style=label.style_none, textcolor=color.green, size=size.tiny)
    tp2Line := line.new(bar_index, shortTP2, bar_index + 20, shortTP2, color=color.lime, width=1, style=line.style_dotted, extend=extend.right)
    tp2Lab  := label.new(bar_index + 3, shortTP2, "TP2 " + str.tostring(shortTP2, format.mintick), style=label.style_none, textcolor=color.lime, size=size.tiny)

// ═══════════════════════════════════════════════════════════════════════════════
// DASHBOARD — FTI style (bottom-left, blue)
// ═══════════════════════════════════════════════════════════════════════════════

if showDashboard and barstate.islast
    var table dash = table.new(position.bottom_left, 2, 10, bgcolor=color.new(color.blue, 40), border_width=1, border_color=color.new(color.blue, 20), frame_width=2, frame_color=color.new(color.blue, 10))

    table.cell(dash, 0, 0, "FibAlgo", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.blue, 20))
    table.cell(dash, 1, 0, "INDICATOR", text_color=color.white, text_size=size.normal, bgcolor=color.new(color.blue, 20))

    // Direction
    string dir = isBull ? "Long" : isBear ? "Short" : "Neutral"
    color dirCol = isBull ? color.green : isBear ? color.red : color.gray
    table.cell(dash, 0, 1, "Direction", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 1, dir, text_color=dirCol, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // Price
    table.cell(dash, 0, 2, "Price", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 2, str.tostring(close, format.mintick), text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // Qty
    float qty = isBull ? longQty : shortQty
    table.cell(dash, 0, 3, "Qty (auto)", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 3, not na(qty) ? str.tostring(qty, "#") : "—", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // Max Loss
    table.cell(dash, 0, 4, "Max Loss", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 4, "$ " + str.tostring(maxLossDollars, "#"), text_color=color.red, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // SL Long
    table.cell(dash, 0, 5, "SL Long", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 5, not na(longSL) ? str.tostring(longSL, format.mintick) : "—", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // SL Short
    table.cell(dash, 0, 6, "SL Short", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 6, not na(shortSL) ? str.tostring(shortSL, format.mintick) : "—", text_color=color.white, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // TP1 / TP2
    float dTP1 = isBull ? longTP1 : shortTP1
    float dTP2 = isBull ? longTP2 : shortTP2
    table.cell(dash, 0, 7, "TP1 / TP2", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    t1s = not na(dTP1) ? str.tostring(dTP1, format.mintick) : "—"
    t2s = not na(dTP2) ? str.tostring(dTP2, format.mintick) : "—"
    table.cell(dash, 1, 7, t1s + " / " + t2s, text_color=color.green, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // R:R
    float rr = isBull ? longRR : shortRR
    table.cell(dash, 0, 8, "R:R", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 8, not na(rr) and rr > 0 ? str.tostring(rr, "#.##") + " : 1" : "—", text_color=color.yellow, text_size=size.small, bgcolor=color.new(color.blue, 50))

    // ATR %
    table.cell(dash, 0, 9, "ATR %", text_color=color.new(color.white, 30), text_size=size.small, bgcolor=color.new(color.blue, 50))
    table.cell(dash, 1, 9, not na(atrPct) ? str.tostring(atrPct, "#.##") + "%" : "—", text_color=color.yellow, text_size=size.small, bgcolor=color.new(color.blue, 50))

// ═══════════════════════════════════════════════════════════════════════════════
// ALERTS
// ═══════════════════════════════════════════════════════════════════════════════

if validLong
    alertMsg = '{"action":"BUY","symbol":"' + syminfo.ticker + '","price":' + str.tostring(close) + ',"sl":' + str.tostring(longSL) + ',"tp1":' + str.tostring(longTP1) + ',"tp2":' + str.tostring(longTP2) + ',"qty":' + str.tostring(longQty) + ',"rr":"' + str.tostring(longRR, "#.#") + '","timeframe":"' + timeframe.period + '"}'
    alert(alertMsg, alert.freq_once_per_bar_close)

if validShort
    alertMsg = '{"action":"SELL","symbol":"' + syminfo.ticker + '","price":' + str.tostring(close) + ',"sl":' + str.tostring(shortSL) + ',"tp1":' + str.tostring(shortTP1) + ',"tp2":' + str.tostring(shortTP2) + ',"qty":' + str.tostring(shortQty) + ',"rr":"' + str.tostring(shortRR, "#.#") + '","timeframe":"' + timeframe.period + '"}'
    alert(alertMsg, alert.freq_once_per_bar_close)

alertcondition(validLong, "FibAlgo Long Entry", "FibAlgo: Long entry signal")
alertcondition(validShort, "FibAlgo Short Entry", "FibAlgo: Short entry signal")
